<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://kit.fontawesome.com/e80beee525.js"
      crossorigin="anonymous"
    ></script>
    <link href="/static/favicon.ico" rel="icon" />
    <link href="/static/styles.css" rel="stylesheet" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css"
      rel="stylesheet"
    />

    <title>Chat Group: {% block title %}{% endblock %}</title>
  </head>
  <body class="flex h-screen">
    {% block main %}{% endblock %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
      integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
      crossorigin="anonymous"
    ></script>
    <script type="text/javascript" charset="utf-8">
      const socket = io();
      socket.on("connect", function () {
        console.log("Connected to the server!");
      });

      socket.on("new_message", function (json) {
        const message = JSON.parse(json);
        const chatMessages = document.querySelector("#message-list");

        if (chatMessages.innerHTML.includes("empty-messages")) {
          chatMessages.innerHTML = "";
        }

        chatMessages.innerHTML += `
        ${
          message.start_date_at
            ? `
            <li class="flex justify-center items-center">
              <hr class="w-full border border-slate-500" />
              <p class="text-xs font-semibold text-slate-300 shrink-0 px-3">
                ${message.start_date_at}
              </p>
              <hr class="w-full border border-slate-500" />
            </li>`
            : ""
        }
          <li class="flex gap-4">
            ${
              message.profile_url
                ? `<img src="${message.profile_url}" alt="Profile Picture" class="w-9 h-9 rounded-lg shrink-0" />`
                : `
            <div
              class="w-9 h-9 bg-slate-300 rounded-lg flex items-center justify-center shrink-0"
            >
              <i class="fa-solid fa-user"></i>
            </div>`
            }
            <div class="flex flex-col gap-1">
              <div class="flex items-center gap-3">
                <span class="font-semibold text-lg text-slate-300">${
                  message.name
                }</span>
                <span class="text-slate-400 text-sm">${
                  message.created_at
                }</span>
              </div>
              <p class="text-lg text-gray-100">${message.message}</p>
            </div>
          </li>
        `;

        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      socket.on("new_member", function (json) {
        const member = JSON.parse(json);
        const memberList = document.querySelector("#member-list");
        memberList.innerHTML =
          `
        <li class="flex items-center text-slate-200">
          ${
            member.profile_url
              ? `
          <img
            src="${member.profile_url}"
            alt="Profile Picture"
            class="w-9 h-9 rounded"
          />`
              : `
          <div class="w-9 h-9 bg-slate-300 rounded flex items-center justify-center">
            <i class="fa-solid fa-user"></i>
          </div>`
          }
          <span class="ml-3 font-semibold text-lg">${member.name}</span>
        </li>
      ` + memberList.innerHTML;
      });

      function resetRoom() {
        socket.emit("reset_room");
      }

      function submitMessage(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const message = formData.get("message");

        socket.emit("new_message", message);
        form.reset();
      }

      function scrollToBottom() {
        const chatMessages = document.getElementById("message-list");
        if (!chatMessages) return;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        chatMessages.classList.remove("invisible");
      }

      window.onload = function () {
        resetRoom();
        scrollToBottom();
      };
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>
